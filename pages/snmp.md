[На главную](../index.md)

```
Новая тема

SNMP - ещё один знаковый протокол мониторинга. **Википедия**
Прикладной уровень. Слушает UDP. 161/162 порт

Может работать в 2 режимах
	1) Режим трапов (trap). Похож в этом режиме на Syslog.
	Что-то произошло в сети и мы об этом сообщаем.
	2) Осуществляет monitoring сети. Например есть база датчиков.
	И в какое-то время мы опрашиваем датчики, например загруженность процессора
	И рисуем графики по данным
	* Иначе говоря - раз в какое то время оббегаем устройства и собираем показатели

Роли в системе:
Управляемое устройство = R / SW ... => SNMP агенты (исп. 161 порт)
NMS (network management system) - система сетевого управления = PC => SNMP менеджер (использует 162 порт)
Менеджеры пробегают по агентам и собирают с них информацию

В основе SNMP есть такое понятие как MIB (management information base) = база данных.
**Картинка первой ссылки в гугле**
Каждый датчик имеет OID (objectID), обращение к ним - последовательная дорога 1(iso).3(org).6(dod).1(internet).4.1.35265

MIB - кусок базы данных который мы можем экспортировать в NMS. И  NMS будет за ним следить

https://vk.com/away.php?to=https%3A%2F%2Fwww.opennet.ru%2Fbase%2Fcisco%2Fcisco_snmp.txt.html&el=snippet
Список популярных датчиков.

---

У SNMP есть 3 версии день на сегодняшний день

Сообщения
В v1
	GetRequest - запросить значение OID (read)
	SetRequest - изменить состояние датчика (write) (не всех, например мы не можем изменить загруженность процессора, но может включить интерфейс удалённо)
	GetNextRequest - перебор датчиков внутри родительской ветки. Например 1.3.6.1.4 1.3.6.1.5 1.3.6.1.6	
	Response - ответ на get, set и request.
	Trap - асинхронное уведомление от агента - менеджеру если что-то произошло на датчике

Важная проблема это security! 
v1 - имеет парольную защиту (password) = в простонародье community = cisco123 => передаётся открытым текстом plain text
v2 - было несколько реализаций.
	v2*, где * - это какая-то буква... Было очень много вариантов.

	По факту работает v2c => password = community = cisco123 => plaint text
+ Добавила функционал
	GetBulkRequest - усовершенствованный getNextRequest, когда мы можем отправить 1 запрос на всю ветку
	InformRequest - модернизированный Trap. В чем фича. Trap отправлялся по UDP, а InformRequest - это Trap с подтверждением доставки
v3 - абсолютно новый протокол с другой структурой сообщения. Очень серьезно прокачана безопасность
	можно создавать user. Их можно составлять группы пользователей. Давать права на определенные OID
	Pavel => Techniker => 3.1.6.4.3
	
	С точки зрения безопасности есть режимы:
	none - всё открыто, без проверок
	auth - проверяется только пользователь (имеет ли он права или нет)
	priv = encription ( шифровать передаваемые данные ).

Разные устройства могут содержать разные версия SNMP. Протоколы версий 1 и 2 могут вообще параллельно работать и не мешать друг-другу.
Настройки ставятся абсолютно похожим образом

---
Практика

Запускаем Virtual Box;
Запускаем Debian

У тюмгу есть сеть. Выход в интернет происходит через proxy server.
И если мы хотим виртуальную машину вывести в интернет нам нужно прописать прокси сервер

Deb: >ip a
На виртуалке настроены два интерфейса
Адаптер 1: GNS3 driver
Адаптер 2: Сетевой мост

И мы словили интернет тюмгу по DHCP

> dhclient <interface> (dhclient -v enp0s8) - позволяет отправить запрос на DHCP чтобы получить адрес
> nano /etc/network/interfaces

dhclient -r enp0s8 - сбросить адрес

Всё для того чтобы установить в линукс пакетик
> export http_proxy=http://study.utmn.ru\\student:P%40ssw0rd@proxy.utmn.ru:8080/ - установить переменные окружения
> env - должны увидеть http_proxy (фото в вк)

> nano /etc/apt/sources.list
Расскоментировать последние строки с deb и deb-src
После bullseye будет update их ндао будет удалить

> apt update

// Если все пойдет не по плану, стоит удалить шлюх по умолчанию. Шлюз по умолчанию должен стоять на сетку тюмгу
> ip r
> ip route del default via 10.10.10.1 dev enp0s3
> dhclient -r enp0s8 

Результат сего должно быть успешное > apt update

> apt install -y snmp
Появилось продолжен после наипсание snmp в терминале

Тушим стенд

В настройках отключаем сетевой мост, готов к пропиху в GNS3

Подключаем напрямую к роутеру

ip address add
ip route add


настравиаем связность между линуксом и роутером (ничего особенного)

Делаем минимально возможный вариант для запуска NSMP

1)
min:
1 ACL (access - list) => прописать IP, которые к нам могут подключаться

R1> conf t
 > access-list 1 permit 10.10.10.0 /24 [log] (можно всей десятой сетке. log - на лог сервер будет отправляться сервер, что кто-то зашёл)
 > no access-list 1 permit 10.10.10.0 /24 log - откатить
 > access-list 1 permit host 10.10.10.10 log

Для настройки используется команда
> snmp-server ?
> snmp-server community cisco123 [ro/rw] [ACL ID] - установили пароль для [ACL ID] в режиме [ro/rw]
 мы прописали для ro и rw для ACL - 1
snmp-server community cisco123 ro 1
snmp-server community cisco345 rw 1

> exit
> show snmp [community]
> show snmp group

В циске как видим параллельно две версии запускаются snmp

Deb> man snmpget
// snmpget -v1(версия) -Cf -c (community) public localhost system.sysUpTime system.sysContact.0
> snmpget -v2c -c cisco123 10.10.10.1 1.3.6.1.2.1.1.5.0 (с того сайта) - вернул имя устройства
Запускаем wireshark на связь и повторяем snmp запрос. Фильтруем по фастфильтру snmp. и смотрим пакет

Может узнать какие ключи живые есть
> snmpwalk -v2c -c cisco123 10.10.10.1 1.3.6.1.2.1.1
Как мы видим перебирает при помощи getNextRequest

Мы также можем изменять значения
> snmpset -v1 -c cisco345 10.10.10.1 1.3.6.1.2.1.1.5.0 s "R5"

```